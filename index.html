<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Mapa milong</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; }
    #map { height: 100%; width: 100%; }
    #selectedFilter { background-color: lightgray; border-radius: 4px; padding: 4px 8px; font-family: 'Arial', sans-serif; font-size: 10px; display: inline-block; }
    .custom-button { background-color: lightgray; border-radius: 4px; padding: 4px 8px; border: 1px solid #888; font-family: 'Arial Black', sans-serif; cursor: pointer; }
    .info-panel { position: absolute; bottom: 55px; left: 10px; background: lightgray; padding: 6px 10px; border-radius: 8px; font-family: 'Arial Black', sans-serif; font-size: 10px; z-index: 5; cursor: pointer; }
    .legend { position: absolute; bottom: 10px; left: 10px; background: lightgray; padding: 6px 10px; border-radius: 8px; font-family: 'Arial Black', sans-serif; font-size: 9px; display: flex; gap: 15px; align-items: center; }
    .legend-icon { width: 16px; height: 16px; }
    /* jeden tooltip-styl dla obu */
    #contactTooltip, #mailTooltip {
      display: none;
      position: absolute;
      bottom: 85px;
      background: lightgray;
      padding: 8px 12px;
      border-radius: 8px;
      font-family: 'Arial Black', sans-serif;
      font-size: 10px;
      z-index: 6;
    }
    #contactTooltip button, #mailTooltip button {
      margin-right: 6px;
      padding: 4px 8px;
      border: 1px solid #888;
      border-radius: 4px;
      cursor: pointer;
      background: white;
    }
  </style>
</head>
<body>
  <!-- górny pasek filtrów -->
  <div style="position: absolute; top: 60px; left: 10px; z-index: 10; display: flex; gap: 12px; align-items: center;">
    <button onclick="openFilterModal()" class="custom-button">Filtruj</button>
    <div id="selectedFilter">Wybrano: najbliższe 3 dni</div>
  </div>

  <!-- sama mapa -->
  <div id="map"></div>

  <!-- panel główny -->
  <div class="info-panel">TDj "Hypno" Piotr Smoleń (0.106)</div>
  <!-- nowy panel z kopertą -->
  <div id="mailPanel" class="info-panel" style="left: 220px;">
    <img class="legend-icon" src="koperta.svg" alt="koperta">
  </div>

  <!-- tooltip dla kontaktu FB -->
  <div id="contactTooltip">
    <p>Napiszesz do mnie?</p>
    <button id="contactYes">Tak</button>
    <button id="contactNo">Nie</button>
  </div>
  <!-- nowy tooltip dla maila -->
  <div id="mailTooltip" style="left: 220px;">
    <p>Wysyłamy email o nowym wydarzeniu?</p>
    <button id="mailYes">Tak</button>
    <button id="mailNo">Nie</button>
  </div>

  <!-- legenda kolorów -->
  <div class="legend">
    <div><img class="legend-icon" src="https://maps.google.com/mapfiles/ms/icons/red-dot.png"> Dzisiaj</div>
    <div><img class="legend-icon" src="https://maps.google.com/mapfiles/ms/icons/orange-dot.png"> Jutro</div>
    <div><img class="legend-icon" src="https://maps.google.com/mapfiles/ms/icons/yellow-dot.png"> Pojutrze</div>
    <div><img class="legend-icon" src="https://maps.google.com/mapfiles/ms/icons/green-dot.png"> Kolejne</div>
    <div><img class="legend-icon" src="https://maps.google.com/mapfiles/ms/icons/blue-dot.png"> Zakończone</div>
  </div>

  <!-- Modal filtrów -->
  <div id="filterModal" style="display:none; position:fixed; top:50%; left:50%; transform: translate(-50%,-50%); background:white; padding:20px; border:1px solid #ccc; z-index:1000; border-radius:8px;">
    <label for="filterSelect">Filtruj wydarzenia: </label>
    <select id="filterSelect" onchange="toggleDateInputs()">
      <option value="all">wszystkie bieżące i przyszłe</option>
      <option value="today">dzisiaj</option>
      <option value="next3days" selected>najbliższe 3 dni</option>
      <option value="week">ten tydzień</option>
      <option value="weekend">ten weekend</option>
      <option value="nextweek">następny tydzień</option>
      <option value="nextweekend">następny weekend</option>
      <option value="range">w zakresie</option>
      <option value="ended">zakończone</option>
    </select><br><br>
    <div id="dateInputs" style="display:none;">
      <label>Od: <input type="date" id="dateFrom"></label><br><br>
      <label>Do: <input type="date" id="dateTo"></label><br><br>
    </div>
    <button onclick="applyFilter()">Filtruj</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/OverlappingMarkerSpiderfier/1.0.3/oms.min.js"></script>
  <script>
    let map, oms, markers = [], eventsData = [], nightMode = false;

    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        zoom: 10,
        center: { lat: 52.1, lng: 19.4 }
      });
      oms = new OverlappingMarkerSpiderfier(map, {
        markersWontMove: true,
        markersWontHide: true,
        keepSpiderfied: true
      });
      const spiderInfo = new google.maps.InfoWindow();
      oms.addListener('click', function(marker) {
        spiderInfo.setContent(marker.customInfo);
        spiderInfo.open(map, marker);
      });
      loadData();
    }

    function loadData() {
      fetch('https://opensheet.elk.sh/1_6bzYSjQZac-QkAytaJD0D81YXcFSOe72Su024smcl0/Arkusz1')
        .then(res => res.json())
        .then(data => {
          eventsData = data.filter(e => e['Opłacone'] === 'Tak');
          applyFilter();
        });
    }

    function openFilterModal() {
      document.getElementById('filterModal').style.display = 'block';
    }
    function toggleDateInputs() {
      document.getElementById('dateInputs').style.display =
        document.getElementById('filterSelect').value === 'range' ? 'block' : 'none';
    }

    function applyFilter() {
      fetch('https://opensheet.elk.sh/1_6bzYSjQZac-QkAytaJD0D81YXcFSOe72Su024smcl0/Arkusz1')
        .then(res => res.json())
        .then(data => {
          eventsData = data.filter(e => e['Opłacone'] === 'Tak');
          const f = document.getElementById('filterSelect').value;
          const now = new Date();
          let from = new Date(now), to = new Date(now), label;
          switch(f) {
            // … Twoja logika filtrowania …
          }
          document.getElementById('selectedFilter').textContent = label;
          displayEvents(from, to);
        });
    }

    function displayEvents(startDate, endDate) {
      markers.forEach(m => m.setMap(null));
      markers = [];
      const geocoder = new google.maps.Geocoder();
      // … Twoja logika tworzenia i podpinania markerów (Spiderfier itp.) …
    }

    document.addEventListener('DOMContentLoaded', () => {
      // tooltip FB
      const panel = document.querySelector('.info-panel');
      const tip   = document.getElementById('contactTooltip');
      const yes   = document.getElementById('contactYes');
      const no    = document.getElementById('contactNo');
      panel.addEventListener('click', e => {
        tip.style.display = tip.style.display === 'block' ? 'none' : 'block';
      });
      yes.addEventListener('click', e => {
        e.stopPropagation();
        tip.style.display = 'none';
        window.open('https://m.me/tdj.hypno.piotr.smolen','_blank');
      });
      no.addEventListener('click', e => {
        e.stopPropagation();
        tip.style.display = 'none';
      });

      // tooltip mail
      const mailPanel = document.getElementById('mailPanel');
      const mailTip   = document.getElementById('mailTooltip');
      const mailYes   = document.getElementById('mailYes');
      const mailNo    = document.getElementById('mailNo');
      mailPanel.addEventListener('click', e => {
        e.stopPropagation();
        mailTip.style.display = mailTip.style.display === 'block' ? 'none' : 'block';
      });
      mailYes.addEventListener('click', e => {
        e.stopPropagation();
        mailTip.style.display = 'none';
        window.location.href =
          'mailto:hypno@poczta.onet.pl'
          + '?subject=' + encodeURIComponent('Pinezka tangowa')
          + '&body='    + encodeURIComponent('Proszę o dodanie pinezki tangowej.');
      });
      mailNo.addEventListener('click', e => {
        e.stopPropagation();
        mailTip.style.display = 'none';
      });

      // klik poza → zamyka oba tooltipy
      document.addEventListener('click', e => {
        if (!panel.contains(e.target) && !tip.contains(e.target)) {
          tip.style.display = 'none';
        }
        if (!mailPanel.contains(e.target) && !mailTip.contains(e.target)) {
          mailTip.style.display = 'none';
        }
      });
    });

    window.initMap = initMap;
  </script>

  <!-- Twój klucz Google Maps i callback -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=TWÓJ_KLUCZ&callback=initMap">
  </script>
</body>
</html>
