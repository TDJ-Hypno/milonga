
<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mapa Milong</title>
  <style>
    #map {
      height: 90vh;
      width: 100%;
    }
    #filter-container {
      padding: 10px;
    }
  </style>
</head>
<body>
  <div id="filter-container">
    <label for="days">Pokaż wydarzenia z najbliższych </label>
    <input type="number" id="days" value="7" min="1" max="365" />
    <label> dni</label>
    <button onclick="loadMap()">Filtruj</button>
  </div>
  <div id="map"></div>

  <script>
    let map;
    let markers = [];

    const sheetId = "1_6bzYSjQZac-QkAytaJD0D81YXcFSOe72Su024smcl0";
    const sheetName = "Arkusz1";

    async function loadMap() {
      const response = await fetch(`https://opensheet.elk.sh/${sheetId}/${sheetName}`);
      const data = await response.json();

      const now = new Date();
      const days = parseInt(document.getElementById("days").value);
      const maxDate = new Date(now);
      maxDate.setDate(now.getDate() + days);

      const filtered = data
        .filter(row => {
          const endDate = new Date(row["Data do"]);
          return endDate >= now && endDate <= maxDate;
        })
        .sort((a, b) => new Date(a["Data od"]) - new Date(b["Data od"])); // sortuj rosnąco wg daty

      if (!map) {
        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 6,
          center: { lat: 52.1, lng: 19.4 },
        });
      }

      // Usuń stare znaczniki
      markers.forEach(marker => marker.setMap(null));
      markers = [];

      const geocoder = new google.maps.Geocoder();

      // Odwróć kolejność dodawania (najbliższe na końcu – będą na wierzchu)
      filtered.reverse().forEach((event) => {
        geocoder.geocode({ address: event.Adres }, (results, status) => {
          if (status === "OK") {
            const position = results[0].geometry.location;
            const startDate = new Date(event["Data od"]);
            const startDateMidnight = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
            const nowMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const dayDiff = Math.floor((startDateMidnight - nowMidnight) / (1000 * 60 * 60 * 24));

            let color;
            if (dayDiff === 0) color = "red";
            else if (dayDiff === 1) color = "orange";
            else if (dayDiff === 2) color = "yellow";
            else color = "green";

            const marker = new google.maps.Marker({
              map,
              position,
              title: `${event.Nazwa}\n${event["Data od"]} – ${event["Data do"]}`,
              icon: {
                url: `http://maps.google.com/mapfiles/ms/icons/${color}-dot.png`,
              }
            });

            markers.push(marker);

            const infoContent = `
              <div>
                <h3>${event.Nazwa}</h3>
                <p><strong>Adres:</strong> ${event.Adres}</p>
                <p><strong>Od:</strong> ${event["Data od"]}</p>
                <p><strong>Do:</strong> ${event["Data do"]}</p>
                <p><strong>Parkietowe:</strong> ${event.Parkietowe}</p>
                <p><strong>Organizator:</strong> ${event.Organizator}</p>
                <p><strong>TDJ:</strong> ${event.TDJ}</p>
                <p><strong>Typ muzyki:</strong> ${event["Typ muzyki"]}</p>
                <p><strong>Info:</strong> ${event.Informacje}</p>
                <p><a href="${event.Link}" target="_blank">Link do wydarzenia</a></p>
                <p><a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(event.Adres)}" target="_blank">
                   <button>Wyznacz trasę do tego miejsca</button></a></p>
              </div>
            `;

            const infowindow = new google.maps.InfoWindow({
              content: infoContent,
            });

            const tooltip = new google.maps.InfoWindow({
              content: `<strong>${event.Nazwa}</strong><br>${event["Data od"]} – ${event["Data do"]}`,
            });

            marker.addListener("click", () => {
              infowindow.open(map, marker);
            });

            marker.addListener("mouseover", () => {
              tooltip.open(map, marker);
            });

            marker.addListener("mouseout", () => {
              tooltip.close();
            });
          }
        });
      });
    }

    window.initMap = loadMap;
  </script>
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAjzcvQPS-dgli4FvWTMnUgkB0Fr4hbkdQ&callback=initMap">
  </script>
</body>
</html>
