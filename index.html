<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Mapa milong</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; }
    #map { height: 100%; width: 100%; }
    .info-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      background: lightgray;
      padding: 6px 12px;
      border-radius: 8px;
      font-family: 'Arial Black', sans-serif;
      font-size: 12px;
      z-index: 5;
    }
    #selectedFilter {
      position: absolute;
      top: 46px;
      left: 10px;
      background: lightgray;
      padding: 4px 10px;
      border-radius: 8px;
      font-family: 'Arial Black', sans-serif;
      font-size: 10px;
      z-index: 5;
    }
    .legend {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: lightgray;
      padding: 10px;
      border-radius: 8px;
      font-size: 12px;
      font-family: 'Arial Black', sans-serif;
      display: flex;
      gap: 15px;
      align-items: center;
    }
    .legend-icon {
      width: 16px;
      height: 16px;
    }
    button {
      background-color: lightgray;
      border-radius: 8px;
      border: 2px solid black;
      font-family: 'Arial Black', sans-serif;
      padding: 6px 10px;
    }
    #filterModal {
      display: none;
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: lightgray;
      padding: 20px;
      border: 1px solid #ccc;
      z-index: 1000;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div class="info-panel">TDj "Hypno" Piotr Smoleń</div>
  <div id="selectedFilter">Pokaż: wszystkie</div>
  <div style="position: absolute; top: 80px; left: 10px; z-index: 10; display: flex; gap: 12px;">
    <button id="themeToggle">Tryb nocny</button>
    <button onclick="openFilterModal()">Filtruj</button>
  </div>
  <div id="filterModal">
    <h3>Pokaż wydarzenia</h3>
    <select id="filterSelect" onchange="toggleDateInputs()">
      <option value="all">wszystkie</option>
      <option value="today">dzisiaj</option>
      <option value="week">ten tydzień</option>
      <option value="weekend">ten weekend</option>
      <option value="nextweek">następny tydzień</option>
      <option value="nextweekend">następny weekend</option>
      <option value="past">zakończone</option>
      <option value="range">w zakresie</option>
    </select><br><br>
    <div id="dateInputs" style="display:none;">
      <label>Od: <input type="date" id="dateFrom"></label><br><br>
      <label>Do: <input type="date" id="dateTo"></label><br><br>
    </div>
    <button onclick="applyFilter()">Filtruj</button>
  </div>
  <div id="map"></div>
  <div class="legend">
    <div><img class="legend-icon" src="https://maps.google.com/mapfiles/ms/icons/red-dot.png"> Dzisiaj</div>
    <div><img class="legend-icon" src="https://maps.google.com/mapfiles/ms/icons/orange-dot.png"> Jutro</div>
    <div><img class="legend-icon" src="https://maps.google.com/mapfiles/ms/icons/yellow-dot.png"> Pojutrze</div>
    <div><img class="legend-icon" src="https://maps.google.com/mapfiles/ms/icons/green-dot.png"> Pozostałe</div>
    <div><img class="legend-icon" src="https://maps.google.com/mapfiles/ms/icons/blue-dot.png"> Minione</div>
  </div>
  <script>
    let map, markers = [], eventsData = [], nightMode = false;
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("themeToggle").addEventListener("click", () => {
        nightMode = !nightMode;
        document.getElementById("themeToggle").textContent = nightMode ? "Tryb dzienny" : "Tryb nocny";
        map.setOptions({ styles: nightMode ? [{ elementType: 'geometry', stylers: [{ color: '#242f3e' }] }] : null });
      });
    });
    function openFilterModal() {
      document.getElementById("filterModal").style.display = "block";
    }
    function toggleDateInputs() {
      const val = document.getElementById("filterSelect").value;
      document.getElementById("dateInputs").style.display = val === "range" ? "block" : "none";
    }
    function applyFilter() {
      const filter = document.getElementById("filterSelect").value;
      const now = new Date();
      let from = new Date(2000, 1, 1), to = new Date(3000, 1, 1), label = "Pokaż: wszystkie";
      const startOfWeek = d => { const date = new Date(d); date.setDate(date.getDate() - date.getDay() + 1); date.setHours(0,0,0,0); return date; };
      const endOfWeek = d => { const date = startOfWeek(d); date.setDate(date.getDate() + 6); date.setHours(23,59,59,999); return date; };
      switch(filter) {
        case "today": from = new Date(); from.setHours(0,0,0,0); to = new Date(); to.setHours(23,59,59,999); label = "Pokaż: dzisiaj"; break;
        case "week": from = startOfWeek(now); to = endOfWeek(now); label = "Pokaż: ten tydzień"; break;
        case "weekend": from = startOfWeek(now); from.setDate(from.getDate() + 4); to = new Date(from); to.setDate(to.getDate() + 2); label = "Pokaż: ten weekend"; break;
        case "nextweek": from = startOfWeek(now); from.setDate(from.getDate() + 7); to = endOfWeek(from); label = "Pokaż: następny tydzień"; break;
        case "nextweekend": from = startOfWeek(now); from.setDate(from.getDate() + 11); to = new Date(from); to.setDate(to.getDate() + 2); label = "Pokaż: następny weekend"; break;
        case "past": from = new Date(2000, 1, 1); to = new Date(); label = "Pokaż: zakończone"; break;
        case "range":
          const d1 = document.getElementById("dateFrom").value;
          const d2 = document.getElementById("dateTo").value;
          if (!d1 || !d2 || new Date(d2) < new Date(d1)) return alert("Nieprawidłowy zakres dat.");
          from = new Date(d1); from.setHours(0,0,0,0); to = new Date(d2); to.setHours(23,59,59,999);
          label = `Pokaż: ${d1} – ${d2}`; break;
      }
      document.getElementById("selectedFilter").textContent = label;
      document.getElementById("filterModal").style.display = "none";
      displayEvents(from, to);
    }
    function displayEvents(startDate, endDate) {
      markers.forEach(m => m.setMap(null)); markers = [];
      eventsData.forEach(event => {
        const start = new Date(event["Data od"]), end = new Date(event["Data do"]);
        if (start > endDate || end < startDate) return;
        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({ address: event.Adres }, (results, status) => {
          if (status === "OK") {
            const pos = results[0].geometry.location;
            const today = new Date(); today.setHours(0,0,0,0);
            const dayDiff = Math.floor((start - today) / (1000 * 60 * 60 * 24));
            let color = "blue"; if (dayDiff === 0) color = "red"; else if (dayDiff === 1) color = "orange"; else if (dayDiff === 2) color = "yellow"; else if (dayDiff > 2) color = "green";
            const marker = new google.maps.Marker({ map, position: pos, icon: `https://maps.google.com/mapfiles/ms/icons/${color}-dot.png`, title: event.Nazwa });
            markers.push(marker);
          }
        });
      });
    }
    function initMap() {
      fetch("https://opensheet.elk.sh/1_6bzYSjQZac-QkAytaJD0D81YXcFSOe72Su024smcl0/Arkusz1")
        .then(res => res.json())
        .then(data => {
          eventsData = data;
          navigator.geolocation.getCurrentPosition(
            pos => {
              const center = { lat: pos.coords.latitude, lng: pos.coords.longitude };
              map = new google.maps.Map(document.getElementById("map"), { zoom: 10, center });
              displayEvents(new Date(2000, 1, 1), new Date(3000, 1, 1));
            },
            () => {
              map = new google.maps.Map(document.getElementById("map"), { zoom: 6, center: { lat: 52.1, lng: 19.4 } });
              displayEvents(new Date(2000, 1, 1), new Date(3000, 1, 1));
            }
          );
        });
    }
    window.initMap = initMap;
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAjzcvQPS-dgli4FvWTMnUgkB0Fr4hbkdQ&callback=initMap"></script>
</body>
</html>
