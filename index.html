
<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Mapa milong</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; }
    #map { height: 100%; width: 100%; }
    .info-panel {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-family: 'Arial Black', sans-serif;
      font-size: 12px;
      z-index: 5;
    }
    .legend {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      font-size: 12px;
      display: flex;
      gap: 15px;
      align-items: center;
    }
    .legend-icon {
      width: 16px;
      height: 16px;
    }
  </style>
</head>
<body>
<div id="map"></div>
<div class="info-panel">Opracowane przez: TDj "Hypno" Piotr Smoleń</div>
<div class="legend">
  <div><img class="legend-icon" src="http://maps.google.com/mapfiles/ms/icons/red-dot.png"> dzisiaj</div>
  <div><img class="legend-icon" src="http://maps.google.com/mapfiles/ms/icons/orange-dot.png"> jutro</div>
  <div><img class="legend-icon" src="http://maps.google.com/mapfiles/ms/icons/yellow-dot.png"> pojutrze</div>
  <div><img class="legend-icon" src="http://maps.google.com/mapfiles/ms/icons/green-dot.png"> pozostałe</div>
  <div><img class="legend-icon" src="http://maps.google.com/mapfiles/ms/icons/blue-dot.png"> minione</div>
</div>
<script>
let map;
let markers = [];
let eventsData = [];

function formatDateForCalendar(dateStr) {
  const dt = new Date(dateStr);
  return dt.toISOString().replace(/-|:|\.\d\d\d/g,"");
}

function loadData() {
  fetch("https://opensheet.elk.sh/1_6bzYSjQZac-QkAytaJD0D81YXcFSOe72Su024smcl0/Arkusz1")
    .then(res => res.json())
    .then(data => {
      eventsData = data;
      displayEvents(new Date(2000, 1, 1), new Date(3000, 1, 1));
    });
}

function displayEvents(startDate, endDate) {
  const now = new Date();
  if (!map) {
    map = new google.maps.Map(document.getElementById("map"), {
      zoom: 6,
      center: { lat: 52.1, lng: 19.4 },
    });
  }

  markers.forEach(marker => marker.setMap(null));
  markers = [];

  const geocoder = new google.maps.Geocoder();
  eventsData.slice().reverse().forEach((event) => {
    geocoder.geocode({ address: event.Adres }, (results, status) => {
      if (status === "OK") {
        const position = results[0].geometry.location;
        const start = new Date(event["Data od"]);
        const end = new Date(event["Data do"]);
        const today = new Date(now); today.setHours(0,0,0,0);
        const dayDiff = Math.floor((start - today) / (1000 * 60 * 60 * 24));
        let color = "blue";
        if (dayDiff === 0) color = "red";
        else if (dayDiff === 1) color = "orange";
        else if (dayDiff === 2) color = "yellow";
        else if (dayDiff > 2) color = "green";

        const marker = new google.maps.Marker({
          map,
          position,
          icon: {
            url: `https://maps.google.com/mapfiles/ms/icons/${color}-dot.png`,
          },
          title: `${event.Nazwa}\n${event["Data od"]} – ${event["Data do"]}`
        });

        markers.push(marker);

        const infoContent = `
          <div style="font-family:'Arial Black', sans-serif;">
            <h3>${event.Nazwa}</h3>
            <p><strong>Adres:</strong> ${event.Adres}</p>
            <p><strong>Od:</strong> ${event["Data od"]}</p>
            <p><strong>Do:</strong> ${event["Data do"]}</p>
            <p><strong>Parkietowe:</strong> ${event.Parkietowe}</p>
            <p><strong>Organizator:</strong> ${event.Organizator}</p>
            <p><strong>TDJ:</strong> ${event.TDJ}</p>
            <p><strong>Typ muzyki:</strong> ${event["Typ muzyki"]}</p>
            <p><strong>Info:</strong> ${event.Informacje}</p>
            <p><a href="${event.Link}" target="_blank">Link do wydarzenia</a></p>
            <p><a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(event.Adres)}" target="_blank">
               <button>Wyznacz trasę do tego miejsca</button></a></p>
            ${new Date(event["Data od"]) > new Date() ? `<p><a href='https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(event.Nazwa)}&dates=${formatDateForCalendar(event["Data od"])}/${formatDateForCalendar(event["Data do"])}&details=${encodeURIComponent(event.Informacje + "\n" + event.Link)}&location=${encodeURIComponent(event.Adres)}' target='_blank'>
               <button>Dodaj do mojego kalendarza</button></a></p>` : ""}
          </div>
        `;

        const infowindow = new google.maps.InfoWindow({ content: infoContent });
        const tooltip = new google.maps.InfoWindow({
          content: `<strong>${event.Nazwa}</strong><br>${event["Data od"]} – ${event["Data do"]}`,
        });

        marker.addListener("click", () => infowindow.open(map, marker));
        marker.addListener("mouseover", () => tooltip.open(map, marker));
        marker.addListener("mouseout", () => tooltip.close());
      }
    });
  });
}

window.initMap = loadData;
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAjzcvQPS-dgli4FvWTMnUgkB0Fr4hbkdQ&callback=initMap"></script>
</body>
</html>
