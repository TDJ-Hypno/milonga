<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Mapa milong</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; }
    #map { height: 100%; width: 100%; }
    .info-panel {
      position: absolute;
      top: 10px;
      right: 10px;
      background: lightgray;
      padding: 8px 12px;
      border-radius: 8px;
      font-family: 'Arial Black', sans-serif;
      font-size: 12px;
      z-index: 5;
    }
    .legend {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: lightgray;
      padding: 10px;
      border-radius: 8px;
      font-size: 12px;
      font-family: 'Arial Black', sans-serif;
      font-weight: bold;
      display: flex;
      gap: 15px;
      align-items: center;
    }
    .legend-icon {
      width: 16px;
      height: 16px;
    }

    /* Styl dla obu przycisków */
    #themeToggle,
    #filterButton {
      background-color: lightgray;              /* tło */
      font-family: 'Arial Black', sans-serif;   /* czcionka */
      font-weight: bold;                        /* pogrubienie */
      border: 2px solid #333;     /* grubsza, ciemna linia */
      border-radius: 6px;         /* zaokrąglone rogi */
      padding: 6px 12px;          /* możesz nieznacznie zwiększyć padding */
      cursor: pointer;                          /* pokazuje rękę przy najechaniu */
    }
    
    /* Opcjonalnie: efekt podświetlenia przy hover */
    #themeToggle:hover,
    #filterButton:hover {
      background-color: #d3d3d3;
      border-color: #000;         /* na hover można przyciemnić obramowanie */
    }

  </style>
</head>
<body>
<div style="position: absolute; top: 60px; left: 10px; z-index: 10; display: flex; gap: 12px; align-items: center;">
  <button id="themeToggle" style="padding: 6px 10px;">Tryb nocny</button>
  <button id="filterButton" onclick="openFilterModal()" style="padding: 6px 10px;">Filtruj</button>
  <div id="selectedFilter" style="margin-left: 10px; font-weight: bold;"></div>
</div>

<!-- Modal filtrów -->
<div id="filterModal" style="display:none; position:fixed;top:50px;left:50%;transform:translateX(-50%);
     background:lightgray;padding:20px;border:1px solid #ccc;z-index:1000;border-radius:8px;">
  <h3>Pokaż wydarzenia</h3>
  <select id="filterSelect" onchange="toggleDateInputs()">
    <option value="all">Wszystkie</option>
    <option value="today">Dzisiaj</option>
    <option value="week">Ten tydzień</option>
    <option value="weekend">Ten weekend</option>
    <option value="nextweek">Następny tydzień</option>
    <option value="nextweekend">Następny weekend</option>
    <option value="range">W zakresie</option>
  </select><br><br>
  <div id="dateInputs" style="display:none;">
    <label>Od: <input type="date" id="dateFrom"></label><br><br>
    <label>Do: <input type="date" id="dateTo"></label><br><br>
  </div>
  <button onclick="applyFilter()">Filtruj</button>
</div>

<div id="map"></div>
<div class="info-panel">Opracowane przez: TDj "Hypno" Piotr Smoleń</div>
<div class="legend">
  <div><img class="legend-icon" src="http://maps.google.com/mapfiles/ms/icons/red-dot.png"> Dzisiaj</div>
  <div><img class="legend-icon" src="http://maps.google.com/mapfiles/ms/icons/orange-dot.png"> Jutro</div>
  <div><img class="legend-icon" src="http://maps.google.com/mapfiles/ms/icons/yellow-dot.png"> Pojutrze</div>
  <div><img class="legend-icon" src="http://maps.google.com/mapfiles/ms/icons/green-dot.png"> Przyszłe</div>
  <div><img class="legend-icon" src="http://maps.google.com/mapfiles/ms/icons/blue-dot.png"> Minione</div>
</div>

<script>

const nightModeStyles = [
  { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
  { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
  { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
  {
    featureType: "administrative.locality",
    elementType: "labels.text.fill",
    stylers: [{ color: "#d59563" }]
  },
  {
    featureType: "poi",
    elementType: "labels.text.fill",
    stylers: [{ color: "#d59563" }]
  },
  {
    featureType: "poi.park",
    elementType: "geometry",
    stylers: [{ color: "#263c3f" }]
  },
  {
    featureType: "poi.park",
    elementType: "labels.text.fill",
    stylers: [{ color: "#6b9a76" }]
  },
  {
    featureType: "road",
    elementType: "geometry",
    stylers: [{ color: "#38414e" }]
  },
  {
    featureType: "road",
    elementType: "geometry.stroke",
    stylers: [{ color: "#212a37" }]
  },
  {
    featureType: "road",
    elementType: "labels.text.fill",
    stylers: [{ color: "#9ca5b3" }]
  },
  {
    featureType: "road.highway",
    elementType: "geometry",
    stylers: [{ color: "#746855" }]
  },
  {
    featureType: "road.highway",
    elementType: "geometry.stroke",
    stylers: [{ color: "#1f2835" }]
  },
  {
    featureType: "road.highway",
    elementType: "labels.text.fill",
    stylers: [{ color: "#f3d19c" }]
  },
  {
    featureType: "transit",
    elementType: "geometry",
    stylers: [{ color: "#2f3948" }]
  },
  {
    featureType: "transit.station",
    elementType: "labels.text.fill",
    stylers: [{ color: "#d59563" }]
  },
  {
    featureType: "water",
    elementType: "geometry",
    stylers: [{ color: "#17263c" }]
  },
  {
    featureType: "water",
    elementType: "labels.text.fill",
    stylers: [{ color: "#515c6d" }]
  },
  {
    featureType: "water",
    elementType: "labels.text.stroke",
    stylers: [{ color: "#17263c" }]
  }
];
  
let map;
let markers = [];
let eventsData = [];
let nightMode = false;

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("themeToggle").addEventListener("click", () => {
    nightMode = !nightMode;
    document.getElementById("themeToggle").textContent = nightMode ? "Tryb dzienny" : "Tryb nocny";
    if (map) {
      map.setOptions({
        // styles: nightMode ? [{ elementType: 'geometry', stylers: [{ color: '#242f3e' }] }] : null
        styles: nightMode ? nightModeStyles : null
      });
    }
  });
});

function loadData() {
  fetch("https://opensheet.elk.sh/1_6bzYSjQZac-QkAytaJD0D81YXcFSOe72Su024smcl0/Arkusz1")
    .then(res => res.json())
    .then(data => {
      eventsData = data;
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const center = {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude
          };
          map = new google.maps.Map(document.getElementById("map"), {
            zoom: 10,
            center: center
          });
          displayEvents(new Date(2000, 1, 1), new Date(3000, 1, 1));
        },
        () => {
          map = new google.maps.Map(document.getElementById("map"), {
            zoom: 6,
            center: { lat: 52.1, lng: 19.4 }
          });
          displayEvents(new Date(2000, 1, 1), new Date(3000, 1, 1));
        }
      );
    });
}

function formatDateForCalendar(dateStr) {
  const dt = new Date(dateStr);
  return dt.toISOString().replace(/-|:|\.\d\d\d/g,"");
}

function displayEvents(startDate, endDate) {
  const now = new Date();
  markers.forEach(marker => marker.setMap(null));
  markers = [];

  const geocoder = new google.maps.Geocoder();
  eventsData.slice().reverse().forEach((event) => {
    geocoder.geocode({ address: event.Adres }, (results, status) => {
      if (status === "OK") {
        const position = results[0].geometry.location;
        const start = new Date(event["Data od"]);
        const today = new Date(now); today.setHours(0,0,0,0);
        const dayDiff = Math.floor((start - today) / (1000 * 60 * 60 * 24));
        let color = "blue";
        if (dayDiff === 0) color = "red";
        else if (dayDiff === 1) color = "orange";
        else if (dayDiff === 2) color = "yellow";
        else if (dayDiff > 2) color = "green";

        const marker = new google.maps.Marker({
          map,
          position,
          icon: {
            url: `https://maps.google.com/mapfiles/ms/icons/${color}-dot.png`,
          },
          // title: `${event.Nazwa}\n${event["Data od"]} – ${event["Data do"]}`
        });

        markers.push(marker);

        const infoContent = `
          <div style="font-family:'Arial Black', sans-serif;">
            <h3>${event.Nazwa}</h3>
            <p><strong>Adres:</strong> ${event.Adres}</p>
            <p><strong>Od:</strong> ${event["Data od"]}</p>
            <p><strong>Do:</strong> ${event["Data do"]}</p>
            <p><strong>Parkietowe:</strong> ${event.Parkietowe}</p>
            <p><strong>Organizator:</strong> ${event.Organizator}</p>
            <p><strong>TDJ:</strong> ${event.TDJ}</p>
            <p><strong>Typ muzyki:</strong> ${event["Typ muzyki"]}</p>
            <p><strong>Info:</strong> ${event.Informacje}</p>
            <p><a href="${event.Link}" target="_blank">Link do wydarzenia</a></p>
            <p><a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(event.Adres)}" target="_blank">
               <button>Wyznacz trasę do tego miejsca</button></a></p>
            ${new Date(event["Data od"]) > new Date() ? `<p><a href='https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(event.Nazwa)}&dates=${formatDateForCalendar(event["Data od"])}/${formatDateForCalendar(event["Data do"])}&details=${encodeURIComponent(event.Informacje + "\n" + event.Link)}&location=${encodeURIComponent(event.Adres)}' target='_blank'>
               <button>Dodaj do mojego kalendarza</button></a></p>` : ""}
          </div>
        `;

        const infowindow = new google.maps.InfoWindow({ content: infoContent });
        const tooltip = new google.maps.InfoWindow({
          content: `<strong>${event.Nazwa}</strong><br>${event["Data od"]} – ${event["Data do"]}`,
        });

        marker.addListener("click", () => infowindow.open(map, marker));
        marker.addListener("mouseover", () => tooltip.open(map, marker));
        marker.addListener("mouseout", () => tooltip.close());
      }
    });
  });
}

function openFilterModal() {
  document.getElementById("filterModal").style.display = "block";
}

function toggleDateInputs() {
  const value = document.getElementById("filterSelect").value;
  document.getElementById("dateInputs").style.display = value === "range" ? "block" : "none";
}

function applyFilter() {
  const filter = document.getElementById("filterSelect").value;
  const now = new Date();
  let from = new Date(2000, 1, 1);
  let to = new Date(3000, 1, 1);
  let label = "";

  function startOfWeek(date) {
    const d = new Date(date);
    d.setDate(d.getDate() - d.getDay() + 1);
    d.setHours(0,0,0,0);
    return d;
  }

  function endOfWeek(date) {
    const d = startOfWeek(date);
    d.setDate(d.getDate() + 6);
    d.setHours(23,59,59,999);
    return d;
  }

  switch(filter) {
    case "today":
      from = new Date(now); from.setHours(0,0,0,0);
      to = new Date(now); to.setHours(23,59,59,999);
      label = "Wybrano: dzisiaj"; break;
    case "week":
      from = startOfWeek(now);
      to = endOfWeek(now);
      label = "Wybrano: ten tydzień"; break;
    case "weekend":
      from = startOfWeek(now); from.setDate(from.getDate() + 4);
      to = new Date(from); to.setDate(to.getDate() + 2);
      label = "Wybrano: ten weekend"; break;
    case "nextweek":
      from = startOfWeek(now); from.setDate(from.getDate() + 7);
      to = endOfWeek(from);
      label = "Wybrano: następny tydzień"; break;
    case "nextweekend":
      from = startOfWeek(now); from.setDate(from.getDate() + 11);
      to = new Date(from); to.setDate(to.getDate() + 2);
      label = "Wybrano: następny weekend"; break;
    case "range":
      const d1 = document.getElementById("dateFrom").value;
      const d2 = document.getElementById("dateTo").value;
      if (!d1 || !d2 || new Date(d2) < new Date(d1)) {
        alert("Nieprawidłowy zakres dat.");
        return;
      }
      from = new Date(d1); from.setHours(0,0,0,0);
      to = new Date(d2); to.setHours(23,59,59,999);
      label = `Wybrano zakres od ${d1} do ${d2}`; break;
    default:
      label = "Wybrano: wszystkie";
  }

  document.getElementById("selectedFilter").textContent = label;
  document.getElementById("filterModal").style.display = "none";
  displayEvents(from, to);
}

window.initMap = loadData;
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAjzcvQPS-dgli4FvWTMnUgkB0Fr4hbkdQ&callback=initMap"></script>
</body>
</html>
