<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Mapa milong</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; }
    #map { height: 100%; width: 100%; }

    #selectedFilter {
      background-color: lightgray;
      border-radius: 8px;
      padding: 4px 8px;
      font-family: 'Arial', sans-serif;
      font-size: 10px;
      display: inline-block;
    }

    .custom-button {
      background-color: lightgray;
      border-radius: 8px;
      padding: 6px 10px;
      border: 2px solid #888;
      font-family: 'Arial Black', sans-serif;
      cursor: pointer;
    }

    .info-panel {
      position: absolute;
      bottom: 50px;
      left: 10px;
      background: lightgray;
      padding: 8px 12px;
      border-radius: 8px;
      font-family: 'Arial Black', sans-serif;
      font-size: 12px;
      z-index: 5;
      cursor: default;
    }
    .legend {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: lightgray;
      padding: 10px;
      border-radius: 8px;
      font-family: 'Arial Black', sans-serif;
      font-size: 12px;
      display: flex;
      gap: 15px;
      align-items: center;
    }
    .legend-icon {
      width: 16px;
      height: 16px;
    }
    #contactTooltip {
      display: none;
      position: absolute;
      background: lightgray;
      padding: 8px;
      border-radius: 8px;
      font-family: 'Arial Black', sans-serif;
      font-size: 12px;
      z-index: 1001;
      pointer-events: auto;
    }
    #contactTooltip button {
      display: block;
      margin-top: 6px;
      padding: 4px 8px;
      border: 1px solid #888;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
<div style="position: absolute; top: 60px; left: 10px; z-index: 10; display: flex; gap: 12px; align-items: center;">
  <button id="themeToggle" class="custom-button">Tryb nocny</button>
  <button onclick="openFilterModal()" class="custom-button">Filtruj</button>
  <div id="selectedFilter">Pokaż: wszystkie</div>
</div>

<!-- Modal filtrów -->
<div id="filterModal" style="display:none; position:fixed;top:50px;left:50%;transform:translateX(-50%);background:lightgray;padding:20px;border:1px solid #ccc;z-index:1000;border-radius:8px;">
  <h3>Pokaż wydarzenia</h3>
  <select id="filterSelect" onchange="toggleDateInputs()">
    <option value="all">wszystkie</option>
    <option value="today">dzisiaj</option>
    <option value="next3days">najbliższe 3 dni</option>
    <option value="week">ten tydzień</option>
    <option value="weekend">ten weekend</option>
    <option value="nextweek">następny tydzień</option>
    <option value="nextweekend">następny weekend</option>
    <option value="range">w zakresie</option>
    <option value="ended">zakończone</option>
  </select><br><br>
  <div id="dateInputs" style="display:none;">
    <label>Od: <input type="date" id="dateFrom"></label><br><br>
    <label>Do: <input type="date" id="dateTo"></label><br><br>
  </div>
  <button onclick="applyFilter()">Filtruj</button>
</div>

<div id="map"></div>
<div class="info-panel">TDj "Hypno" Piotr Smoleń (0.0932)</div>
<div class="legend">
  <div><img class="legend-icon" src="https://maps.google.com/mapfiles/ms/icons/red-dot.png"> Dzisiaj</div>
  <div><img class="legend-icon" src="https://maps.google.com/mapfiles/ms/icons/orange-dot.png"> Jutro</div>
  <div><img class="legend-icon" src="https://maps.google.com/mapfiles/ms/icons/yellow-dot.png"> Pojutrze</div>
  <div><img class="legend-icon" src="https://maps.google.com/mapfiles/ms/icons/green-dot.png"> Kolejne</div>
  <div><img class="legend-icon" src="https://maps.google.com/mapfiles/ms/icons/blue-dot.png"> Zakończone</div>
</div>

<!-- Tooltip kontaktu -->
<div id="contactTooltip">
  <p>Czy chcesz skontaktować się ze mną?</p>
  <button id="contactYes">Tak</button>
  <button id="contactNo">Nie</button>
</div>

<script>
let map;
let markers = [];
let eventsData = [];
let nightMode = false;

function loadData() {
  fetch("https://opensheet.elk.sh/1_6bzYSjQZac-QkAytaJD0D81YXcFSOe72Su024smcl0/Arkusz1")
    .then(res => res.json())
    .then(data => {
      eventsData = data;
      navigator.geolocation.getCurrentPosition(pos => {
          const center = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          map = new google.maps.Map(document.getElementById("map"), { zoom: 10, center });
          displayEvents(new Date(2000,1,1), new Date(3000,1,1));
        }, () => {
          map = new google.maps.Map(document.getElementById("map"), { zoom: 6, center: { lat: 52.1, lng: 19.4 } });
          displayEvents(new Date(2000,1,1), new Date(3000,1,1));
        }
      );
    });
}

function openFilterModal() { document.getElementById("filterModal").style.display = "block"; }
function toggleDateInputs() { document.getElementById("dateInputs").style.display = document.getElementById("filterSelect").value === "range" ? "block" : "none"; }

function applyFilter() {
  const filter = document.getElementById("filterSelect").value;
  const now = new Date(); let from = new Date(2000,1,1), to = new Date(3000,1,1), label = "";
  function startOfWeek(d) { const dt=new Date(d); dt.setDate(dt.getDate()-dt.getDay()+1); dt.setHours(0,0,0,0); return dt; }
  function endOfWeek(d) { const dt=startOfWeek(d); dt.setDate(dt.getDate()+6); dt.setHours(23,59,59,999); return dt; }
  switch(filter) {
    case "today": from=new Date(now); from.setHours(0,0,0,0); to=new Date(now); to.setHours(23,59,59,999); label="Pokaż: dzisiaj"; break;
    case "next3days": from=new Date(now); from.setHours(0,0,0,0); to=new Date(from); to.setDate(to.getDate()+2); to.setHours(23,59,59,999); label="Pokaż: najbliższe 3 dni"; break;
    case "week": from=startOfWeek(now); to=endOfWeek(now); label="Pokaż: ten tydzień"; break;
    case "weekend": from=startOfWeek(now); from.setDate(from.getDate()+4); from.setHours(0,0,0,0); to=new Date(from); to.setDate(to.getDate()+2); to.setHours(23,59,59,999); label="Pokaż: ten weekend"; break;
    case "nextweek": from=startOfWeek(now); from.setDate(from.getDate()+7); from.setHours(0,0,0,0); to=endOfWeek(from); label="Pokaż: następny tydzień"; break;
    case "nextweekend": from=startOfWeek(now); from.setDate(from.getDate()+11); from.setHours(0,0,0,0); to=new Date(from); to.setDate(to.getDate()+2); to.setHours(23,59,59,999); label="Pokaż: następny weekend"; break;
    case "range": { const d1=document.getElementById("dateFrom").value, d2=document.getElementById("dateTo").value; if(!d1||!d2||new Date(d2)<new Date(d1)){ alert("Nieprawidłowy zakres dat."); return;} from=new Date(d1); from.setHours(0,0,0,0); to=new Date(d2); to.setHours(23,59,59,999); label=`Pokaż zakres od ${d1} do ${d2}`; break; }
    case "ended": from=new Date(2000,1,1); to=new Date(now); to.setHours(23,59,59,999); label="Pokaż: zakończone"; break;
    default: label="Pokaż: wszystkie";
  }
  document.getElementById("selectedFilter").textContent=label;
  document.getElementById("filterModal").style.display="none";
  displayEvents(from,to);
}

function displayEvents(startDate,endDate) {
  const now=new Date(); const today=new Date(now); today.setHours(0,0,0,0);
  markers.forEach(m=>m.setMap(null)); markers=[];
  const geocoder=new google.maps.Geocoder();
  function fmtCal(s){const d=new Date(s);return d.toISOString().replace(/-|:|\.\d{3}/g,"");}
  const ended=eventsData.filter(e=>new Date(e["Data do"])<today).sort((a,b)=>new Date(a["Data od"]) - new Date(b["Data od"]));
  const future=eventsData.filter(e=>new Date(e["Data do"])>=today).sort((a,b)=>new Date(b["Data od"]) - new Date(a["Data od"]));
  [...ended,...future].forEach((event,i)=>{const s=new Date(event["Data od"]), e=new Date(event["Data do"]);if(s> endDate||e< startDate) return;geocoder.geocode({address:event.Adres},(res,st)=>{if(st!="OK")return;const pos=res[0].geometry.location;const dd=Math.floor((s-today)/(1000*60*60*24));let c="blue";if(dd===0)c="red";else if(dd===1)c="orange";else if(dd===2)c="yellow";else if(dd>2)c="green";const m=new google.maps.Marker({map,position:pos,optimized:false,zIndex:i,icon:{url:`https://maps.google.com/mapfiles/ms/icons/${c}-dot.png`},title:`${event.Nazwa}\n${event["Data od"]} – ${event["Data do"]}`});markers.push(m);let cs="";if(s>now){const sf=fmtCal(event["Data od"]), ef=fmtCal(event["Data do"]);cs=`<p><a href="https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(event.Nazwa)}&dates=${sf}/${ef}&details=${encodeURIComponent(event.Informacje+"\n"+event.Link)}&location=${encodeURIComponent(event.Adres)}" target="_blank"><button>Dodaj do kalendarza</button></a></p>`;}const ic=`<div style="font-family:'Arial Black', sans-serif;"><h3>${event.Nazwa}</h3><p><strong>Adres:</strong>${event.Adres}</p><p><strong>Od:</strong>${event["Data od"]}</p><p><strong>Do:</strong>${event["Data do"]}</p><p><strong>Parkietowe:</strong>${event.Parkietowe}</p><p><strong>Organizator:</strong>${event.Organizator}</p><p><strong>TDJ:</strong>${event.TDJ}</p><p><strong>Typ muzyki:</strong>${event["Typ muzyki"]}</p><p><strong>Info:</strong>${event.Informacje}</p><p><a href="${event.Link}" target="_blank">Link do wydarzenia</a></p><p><a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(event.Adres)}" target="_blank"><button>Wyznacz trasę</button></a></p>${cs}</div>`;const iw=new google.maps.InfoWindow({content:ic});m.addListener("click",()=>iw.open(map,m));});});
}

window.initMap=loadData;

// Kontakt tooltip logic
let hideTimeout;
document.addEventListener('DOMContentLoaded',function(){
  const infoPanel=document.querySelector('.info-panel');
  const tooltip=document.getElementById('contactTooltip');
  const btn=document.getElementById('contactYes');
  const btn=document.getElementById('contactNo');

  function showTooltip(){
    clearTimeout(hideTimeout);
    const rect=infoPanel.getBoundingClientRect();
    tooltip.style.left=rect.left+'px';
    tooltip.style.top=rect.bottom+4+'px';
    tooltip.style.display='block';
  }
  function hideTooltip(){ tooltip.style.display='none'; }
  function scheduleHide(){
    hideTimeout=setTimeout(()=>{
      if(!infoPanel.matches(':hover')&&!tooltip.matches(':hover')) hideTooltip();
    },200);
  }

  infoPanel.addEventListener('click',showTooltip);
  tooltip.addEventListener('mouseenter',()=>clearTimeout(hideTimeout));
  tooltip.addEventListener('mouseleave',scheduleHide);
  btn.addEventListener('click',function(e){ e.stopPropagation(); window.open('https://m.me/tdj.hypno.piotr.smolen','_blank'); });
});
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAjzcvQPS-dgli4FvWTMnUgkB0Fr4hbkdQ&callback=initMap"></script>
</body>
</html>
